<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowLog ‚Äî Gut Health Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F5F3EF;
    --surface: #FFFFFF;
    --surface2: #EEF0F2;
    --border: #E0DDD8;
    --text: #1A1A18;
    --muted: #7A7871;
    --accent: #2D6A4F;
    --accent-light: #D8EDE4;
    --warn: #C77B3A;
    --warn-light: #FAEBD7;
    --danger: #B5433A;
    --blue: #2C5F8A;
    --blue-light: #D6E8F5;
    --urine-1: #F5F0C0;
    --urine-2: #F0E070;
    --urine-3: #E8C830;
    --urine-4: #D4A020;
    --urine-5: #B07010;
    --urine-6: #8B4800;
    --urine-7: #5C2E00;
    --urine-8: #3A1800;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    max-width: 480px;
    margin: 0 auto;
    padding-bottom: 100px;
  }

  /* HEADER */
  .header {
    padding: 28px 24px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    letter-spacing: -0.5px;
    line-height: 1;
  }

  .logo span { font-style: italic; color: var(--accent); }

  .date-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 4px;
  }

  .streak-badge {
    background: var(--accent-light);
    color: var(--accent);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: 0.05em;
  }

  /* NAV TABS */
  .nav {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }

  .nav-btn {
    flex: 1;
    padding: 10px 0;
    background: none;
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .nav-btn.active {
    color: var(--text);
    border-bottom-color: var(--accent);
  }

  /* SECTIONS */
  .section { display: none; }
  .section.active { display: block; }

  /* LOG SECTION */
  .log-section { padding: 20px 20px 0; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 14px;
  }

  .card-title {
    font-family: 'DM Serif Display', serif;
    font-size: 18px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title .icon {
    font-size: 20px;
  }

  /* URINE COLOR PICKER */
  .urine-scale {
    display: flex;
    gap: 4px;
    margin-bottom: 10px;
  }

  .urine-swatch {
    flex: 1;
    height: 36px;
    border-radius: 6px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform 0.15s, border-color 0.15s;
    position: relative;
  }

  .urine-swatch:hover { transform: scaleY(1.1); }
  .urine-swatch.selected { border-color: var(--text); transform: scaleY(1.15); }

  .urine-label {
    font-size: 10px;
    color: var(--muted);
    text-align: center;
    margin-top: 6px;
    min-height: 28px;
  }

  /* BRISTOL SCALE */
  .bristol-grid {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .bristol-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: none;
    cursor: pointer;
    text-align: left;
    width: 100%;
    font-family: 'DM Mono', monospace;
    transition: all 0.15s;
  }

  .bristol-btn:hover { background: var(--surface2); }

  .bristol-btn.selected {
    border-color: var(--accent);
    background: var(--accent-light);
  }

  .bristol-num {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    width: 28px;
    text-align: center;
    color: var(--accent);
    flex-shrink: 0;
  }

  .bristol-info { flex: 1; }

  .bristol-name {
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.03em;
  }

  .bristol-desc {
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
    letter-spacing: 0.02em;
  }

  .bristol-visual {
    font-size: 20px;
    flex-shrink: 0;
  }

  /* HYDRATION */
  .hydration-display {
    text-align: center;
    margin-bottom: 12px;
  }

  .hydration-count {
    font-family: 'DM Serif Display', serif;
    font-size: 52px;
    line-height: 1;
    color: var(--blue);
  }

  .hydration-unit {
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .hydration-glasses {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
    margin: 14px 0;
  }

  .glass {
    width: 34px;
    height: 42px;
    border: 2px solid var(--border);
    border-radius: 4px 4px 6px 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    background: var(--surface);
    transition: border-color 0.15s;
  }

  .glass.filled {
    border-color: var(--blue);
    background: var(--blue-light);
  }

  .glass:hover { border-color: var(--blue); }

  .glass::after {
    content: 'üíß';
    position: absolute;
    font-size: 16px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0;
    transition: opacity 0.15s;
  }

  .glass.filled::after { opacity: 1; }

  .hydration-btns {
    display: flex;
    gap: 8px;
  }

  /* BUTTONS */
  .btn {
    padding: 11px 18px;
    border-radius: 8px;
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.06em;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    flex: 1;
  }

  .btn-primary:hover { background: #245c43; }
  .btn-primary:active { transform: scale(0.97); }

  .btn-outline {
    background: none;
    border: 1.5px solid var(--border);
    color: var(--text);
    flex: 1;
  }

  .btn-outline:hover { background: var(--surface2); }

  .btn-sm {
    padding: 7px 14px;
    font-size: 11px;
  }

  /* LOG BUTTON */
  .log-actions {
    display: flex;
    gap: 8px;
    padding: 0 20px 20px;
  }

  /* TODAY'S LOG */
  .log-entries { padding: 0 20px; }

  .log-entries-title {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .entry {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 6px;
    animation: slideIn 0.25s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .entry-type {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .entry-type.urine { background: var(--warn-light); }
  .entry-type.bowel { background: var(--accent-light); }
  .entry-type.water { background: var(--blue-light); }

  .entry-info { flex: 1; }

  .entry-title {
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.03em;
  }

  .entry-detail {
    font-size: 10px;
    color: var(--muted);
    margin-top: 1px;
  }

  .entry-time {
    font-size: 10px;
    color: var(--muted);
    flex-shrink: 0;
  }

  .entry-delete {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 4px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .entry:hover .entry-delete { opacity: 1; }

  /* HISTORY SECTION */
  .history-section { padding: 20px; }

  .week-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .week-nav-btn {
    background: none;
    border: 1.5px solid var(--border);
    width: 34px;
    height: 34px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
  }

  .week-nav-btn:hover { background: var(--surface2); }

  .week-label {
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.05em;
  }

  /* MINI CALENDAR */
  .mini-cal {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 16px;
  }

  .cal-day-head {
    font-size: 9px;
    color: var(--muted);
    text-align: center;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    padding-bottom: 4px;
  }

  .cal-day {
    aspect-ratio: 1;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    cursor: pointer;
    border: 1.5px solid transparent;
    background: var(--surface);
    transition: all 0.15s;
    gap: 2px;
  }

  .cal-day:hover { border-color: var(--border); }
  .cal-day.today { border-color: var(--accent); font-weight: 500; }
  .cal-day.selected { background: var(--accent); color: white; }

  .cal-dot-row {
    display: flex;
    gap: 2px;
  }

  .cal-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
  }

  /* CHARTS */
  .chart-card { margin-bottom: 14px; }

  .chart-title {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 80px;
  }

  .bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 100%;
    justify-content: flex-end;
  }

  .bar {
    width: 100%;
    border-radius: 4px 4px 0 0;
    min-height: 4px;
    transition: height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .bar.water-bar { background: var(--blue); }
  .bar.urine-bar { background: var(--warn); }
  .bar.bowel-bar { background: var(--accent); }

  .bar-label {
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.03em;
  }

  /* STATS ROW */
  .stats-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-bottom: 14px;
  }

  .stat-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 10px;
    text-align: center;
  }

  .stat-value {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    line-height: 1;
  }

  .stat-label {
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.07em;
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* INSIGHTS */
  .insight {
    display: flex;
    gap: 10px;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 8px;
    border: 1px solid transparent;
  }

  .insight.good { background: var(--accent-light); border-color: #b2d8c8; }
  .insight.warn { background: var(--warn-light); border-color: #e8c8a0; }
  .insight.info { background: var(--blue-light); border-color: #a8ccec; }

  .insight-icon { font-size: 18px; flex-shrink: 0; }

  .insight-text { font-size: 11px; line-height: 1.5; letter-spacing: 0.02em; }
  .insight-text strong { font-size: 11px; }

  /* BOTTOM NAV */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    padding: 8px 0 16px;
  }

  .bottom-nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px 0;
    color: var(--muted);
    transition: color 0.15s;
    font-family: 'DM Mono', monospace;
  }

  .bottom-nav-btn.active { color: var(--accent); }

  .bottom-nav-btn svg { width: 22px; height: 22px; }
  .bottom-nav-label { font-size: 9px; letter-spacing: 0.06em; text-transform: uppercase; }

  /* FAB */
  .fab {
    position: fixed;
    bottom: 72px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 200;
  }

  .fab-btn {
    width: 56px;
    height: 56px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 26px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(45,106,79,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .fab-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 24px rgba(45,106,79,0.5);
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 300;
    align-items: flex-end;
  }

  .modal-overlay.open {
    display: flex;
    animation: fadeIn 0.2s;
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .modal {
    background: var(--surface);
    border-radius: 20px 20px 0 0;
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    padding: 20px;
    max-height: 85vh;
    overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  .modal-handle {
    width: 36px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 18px;
  }

  .modal-title {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    margin-bottom: 16px;
  }

  .modal-type-btns {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }

  .type-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: none;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    transition: all 0.15s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .type-btn:hover { background: var(--surface2); }
  .type-btn.active { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
  .type-btn .t-icon { font-size: 24px; }

  .modal-form { display: none; }
  .modal-form.active { display: block; }

  .form-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 8px;
    display: block;
  }

  .form-group { margin-bottom: 16px; }

  .notes-input {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    background: var(--surface);
    color: var(--text);
    resize: none;
    outline: none;
    transition: border-color 0.15s;
  }

  .notes-input:focus { border-color: var(--accent); }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 16px 0;
  }

  .urine-color-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border-radius: 8px;
    margin-top: 8px;
    font-size: 11px;
  }

  .color-swatch-preview {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid var(--border);
    flex-shrink: 0;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }

  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-text { font-size: 12px; letter-spacing: 0.04em; line-height: 1.6; }

  .section-pad { padding: 20px; }

  /* TOAST */
  .toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--text);
    color: white;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 12px;
    letter-spacing: 0.04em;
    z-index: 500;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    white-space: nowrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .progress-bar {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 2px;
    background: var(--blue);
    transition: width 0.4s ease;
  }

  .water-goal-text {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.05em;
    margin-top: 6px;
    text-align: center;
  }

  /* ====== CAMERA SCANNER ====== */
  .cam-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 600;
    flex-direction: column;
  }
  .cam-overlay.open { display: flex; }

  .cam-video {
    flex: 1;
    width: 100%;
    object-fit: cover;
  }

  .cam-ui {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .cam-reticle {
    width: 110px;
    height: 110px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.9);
    box-shadow: 0 0 0 4000px rgba(0,0,0,0.45), 0 0 20px rgba(255,255,255,0.3);
    position: relative;
    transition: border-color 0.2s;
  }

  .cam-reticle::before, .cam-reticle::after {
    content: '';
    position: absolute;
    background: rgba(255,255,255,0.7);
  }
  .cam-reticle::before { width: 1px; height: 20px; top: 50%; left: 50%; transform: translate(-50%,-50%); }
  .cam-reticle::after  { width: 20px; height: 1px; top: 50%; left: 50%; transform: translate(-50%,-50%); }

  .cam-reticle-inner {
    position: absolute;
    inset: 10px;
    border-radius: 50%;
    transition: background 0.15s;
  }

  .cam-hint {
    margin-top: 20px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: rgba(255,255,255,0.8);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    text-align: center;
    text-shadow: 0 1px 4px rgba(0,0,0,0.8);
  }

  .cam-result-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(10px);
    padding: 20px 20px 36px;
    pointer-events: all;
  }

  .cam-result-row {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 14px;
  }

  .cam-detected-swatch {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.3);
    flex-shrink: 0;
    transition: background 0.15s;
  }

  .cam-result-info { flex: 1; }

  .cam-result-level {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: white;
    line-height: 1;
  }

  .cam-result-label {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    margin-top: 3px;
    letter-spacing: 0.04em;
  }

  .cam-mini-scale {
    display: flex;
    gap: 4px;
    margin-bottom: 14px;
  }

  .cam-mini-swatch {
    flex: 1;
    height: 10px;
    border-radius: 3px;
    opacity: 0.5;
    transition: opacity 0.2s, transform 0.2s;
  }
  .cam-mini-swatch.active {
    opacity: 1;
    transform: scaleY(1.6);
    border-radius: 3px 3px 0 0;
  }

  .cam-actions {
    display: flex;
    gap: 10px;
  }

  .cam-btn {
    flex: 1;
    padding: 13px;
    border-radius: 10px;
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
  }

  .cam-btn-cancel {
    background: rgba(255,255,255,0.12);
    color: white;
  }

  .cam-btn-confirm {
    background: var(--accent);
    color: white;
  }

  .cam-btn-confirm:active { transform: scale(0.97); }

  .cam-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 52px 20px 16px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
    display: flex;
    justify-content: space-between;
    align-items: center;
    pointer-events: all;
  }

  .cam-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: white;
  }

  .cam-close {
    background: rgba(255,255,255,0.15);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cam-scan-btn {
    background: none;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.06em;
    cursor: pointer;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 12px;
    transition: background 0.15s;
    width: 100%;
    justify-content: center;
  }
  .cam-scan-btn:hover { background: var(--accent-light); }
  .cam-scan-btn svg { width: 16px; height: 16px; }

  .cam-no-support {
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    padding: 8px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 12px;
  }

  /* ====== URGENCY / DURATION / SYMPTOMS ====== */
  .urgency-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 7px;
    margin-bottom: 4px;
  }

  .urgency-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 8px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    background: none;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.03em;
    color: var(--text);
    transition: all 0.15s;
  }

  .urgency-btn:hover { background: var(--surface2); }
  .urgency-btn.selected { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
  .urgency-btn .u-emoji { font-size: 22px; }

  .duration-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .duration-value {
    font-family: 'DM Serif Display', serif;
    font-size: 18px;
    color: var(--accent);
  }

  .duration-slider {
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    border-radius: 2px;
    background: var(--border);
    outline: none;
    margin-bottom: 4px;
  }

  .duration-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }

  .duration-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }

  .duration-ticks {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.04em;
    margin-bottom: 2px;
  }

  .symptom-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .symptom-item {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
  }

  .symptom-item input[type="checkbox"] {
    display: none;
  }

  .symptom-box {
    width: 20px;
    height: 20px;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
    font-size: 12px;
  }

  .symptom-item input:checked + .symptom-box {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .symptom-label {
    font-size: 12px;
    letter-spacing: 0.02em;
  }

  .form-divider {
    height: 1px;
    background: var(--border);
    margin: 14px 0;
  }
</style>
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <div>
      <div class="logo">Flow<span>Log</span></div>
      <div class="date-label" id="dateLabel"></div>
    </div>
    <div class="streak-badge" id="streakBadge">üî• 1-day streak</div>
  </div>
</div>

<!-- NAV -->
<div class="nav">
  <button class="nav-btn active" onclick="switchTab('log')">Today</button>
  <button class="nav-btn" onclick="switchTab('history')">History</button>
  <button class="nav-btn" onclick="switchTab('insights')">Insights</button>
</div>

<!-- ===== LOG SECTION ===== -->
<div class="section active" id="section-log">
  <div class="log-section">

    <!-- HYDRATION CARD -->
    <div class="card">
      <div class="card-title"><span class="icon">üíß</span> Hydration</div>
      <div class="hydration-display">
        <div class="hydration-count" id="hydrationCount">0</div>
        <div class="hydration-unit">glasses today</div>
        <div class="progress-bar">
          <div class="progress-fill" id="hydrationProgress" style="width:0%"></div>
        </div>
        <div class="water-goal-text" id="waterGoalText">0 / 8 glasses ‚Äî keep going!</div>
      </div>
      <div class="hydration-glasses" id="glassesRow"></div>
      <div class="hydration-btns">
        <button class="btn btn-outline btn-sm" onclick="addWater(-1)">‚àí Remove</button>
        <button class="btn btn-primary btn-sm" onclick="addWater(1)">+ Add Glass</button>
      </div>
    </div>

  </div>

  <!-- TODAY'S ENTRIES -->
  <div class="log-entries">
    <div class="log-entries-title">Today's Log</div>
    <div id="entryList">
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <div class="empty-text">No entries yet today.<br>Tap + to log a movement.</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== HISTORY SECTION ===== -->
<div class="section" id="section-history">
  <div class="history-section">
    <div class="week-nav">
      <button class="week-nav-btn" onclick="changeWeek(-1)">‚Äπ</button>
      <div class="week-label" id="weekLabel"></div>
      <button class="week-nav-btn" onclick="changeWeek(1)">‚Ä∫</button>
    </div>
    <div class="mini-cal" id="miniCal"></div>
    <div class="card chart-card">
      <div class="chart-title">Weekly Activity</div>
      <div class="bar-chart" id="weekChart"></div>
      <div style="display:flex;gap:12px;margin-top:10px">
        <div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)">
          <div style="width:10px;height:10px;background:var(--blue);border-radius:2px"></div>Water
        </div>
        <div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)">
          <div style="width:10px;height:10px;background:var(--warn);border-radius:2px"></div>Urine
        </div>
        <div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)">
          <div style="width:10px;height:10px;background:var(--accent);border-radius:2px"></div>Bowel
        </div>
      </div>
    </div>

    <div class="stats-row" id="weekStats">
      <div class="stat-box">
        <div class="stat-value" id="avgWater">‚Äì</div>
        <div class="stat-label">Avg Glasses</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="totalUrine">‚Äì</div>
        <div class="stat-label">Urine Events</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="totalBowel">‚Äì</div>
        <div class="stat-label">Bowel Events</div>
      </div>
    </div>

  </div>
</div>

<!-- ===== INSIGHTS SECTION ===== -->
<div class="section" id="section-insights">
  <div class="section-pad">
    <div class="card">
      <div class="card-title"><span class="icon">üî¨</span> Health Insights</div>
      <div id="insightsList"></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üìä</span> Bristol Scale Reference</div>
      <div class="bristol-grid" id="bristolRef"></div>
    </div>
  </div>
</div>

<!-- FAB -->
<div class="fab">
  <button class="fab-btn" onclick="openModal()">+</button>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="bottom-nav-btn active" id="nav-log" onclick="switchTab('log')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
      <rect x="3" y="3" width="18" height="18" rx="3"/>
      <line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="8" x2="16" y2="8"/>
      <line x1="8" y1="16" x2="12" y2="16"/>
    </svg>
    <span class="bottom-nav-label">Today</span>
  </button>
  <button class="bottom-nav-btn" id="nav-history" onclick="switchTab('history')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
      <rect x="3" y="4" width="18" height="18" rx="2"/>
      <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
      <line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
    <span class="bottom-nav-label">History</span>
  </button>
  <button class="bottom-nav-btn" id="nav-insights" onclick="switchTab('insights')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
    </svg>
    <span class="bottom-nav-label">Insights</span>
  </button>
</div>

<!-- LOG MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Log Entry</div>

    <!-- TYPE SELECT -->
    <div class="modal-type-btns">
      <button class="type-btn active" onclick="selectType('urine')" id="typeUrine">
        <span class="t-icon">üöø</span>Urine
      </button>
      <button class="type-btn" onclick="selectType('bowel')" id="typeBowel">
        <span class="t-icon">ü™∫</span>Bowel
      </button>
    </div>

    <!-- URINE FORM -->
    <div class="modal-form active" id="formUrine">
      <label class="form-label">Urine Color (1 = clear, 8 = dark)</label>

      <!-- CAMERA SCAN BUTTON -->
      <div id="camScanWrapper">
        <button class="cam-scan-btn" onclick="handleCameraTap()" id="camScanBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          Scan with Camera
        </button>
      </div>

      <div class="urine-scale" id="urineScale"></div>
      <div class="urine-color-indicator" id="urineColorInfo">
        <div class="color-swatch-preview" id="urinePreview"></div>
        <span id="urineColorLabel">Select a color above or scan</span>
      </div>

      <div class="form-divider"></div>

      <!-- URGENCY -->
      <div class="form-group">
        <label class="form-label">Urgency Level</label>
        <div class="urgency-grid" id="urineUrgencyGrid">
          <button class="urgency-btn selected" data-level="1" onclick="selectUrgency('urine',1,this)"><span class="u-emoji">üòå</span>No rush</button>
          <button class="urgency-btn" data-level="2" onclick="selectUrgency('urine',2,this)"><span class="u-emoji">ü§î</span>Mild urgency</button>
          <button class="urgency-btn" data-level="3" onclick="selectUrgency('urine',3,this)"><span class="u-emoji">üò∞</span>Moderate urgency</button>
          <button class="urgency-btn" data-level="4" onclick="selectUrgency('urine',4,this)"><span class="u-emoji">üò±</span>Very urgent</button>
        </div>
      </div>

      <!-- DURATION -->
      <div class="form-group">
        <div class="duration-row">
          <label class="form-label" style="margin:0">Duration</label>
          <span class="duration-value" id="urineDurVal">1 min</span>
        </div>
        <input type="range" class="duration-slider" id="urineDuration" min="0" max="30" value="1"
          oninput="document.getElementById('urineDurVal').textContent=this.value<1?'<1 min':this.value+' min'">
        <div class="duration-ticks"><span>&lt;1</span><span>5</span><span>10</span><span>15</span><span>20</span><span>25</span><span>30+</span></div>
      </div>

      <!-- SYMPTOMS -->
      <div class="form-group">
        <label class="form-label">Symptoms</label>
        <div class="symptom-list">
          <label class="symptom-item"><input type="checkbox" id="uSym1"><div class="symptom-box">‚úì</div><span class="symptom-label">Felt complete / satisfying</span></label>
          <label class="symptom-item"><input type="checkbox" id="uSym2"><div class="symptom-box">‚úì</div><span class="symptom-label">Burning or discomfort</span></label>
          <label class="symptom-item"><input type="checkbox" id="uSym3"><div class="symptom-box">‚úì</div><span class="symptom-label">Cloudy or unusual appearance</span></label>
          <label class="symptom-item"><input type="checkbox" id="uSym4"><div class="symptom-box">‚úì</div><span class="symptom-label">Noticed blood</span></label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Notes (optional)</label>
        <textarea class="notes-input" id="urineNotes" rows="2" placeholder="Any additional observations, foods eaten, medications, etc."></textarea>
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="submitLog('urine')">Log Urine</button>
    </div>

    <!-- BOWEL FORM -->
    <div class="modal-form" id="formBowel">
      <label class="form-label">Bristol Stool Scale ‚Äî Select Type</label>
      <div class="bristol-grid" id="bristolSelect"></div>

      <div class="form-divider"></div>

      <!-- URGENCY -->
      <div class="form-group">
        <label class="form-label">Urgency Level</label>
        <div class="urgency-grid" id="bowelUrgencyGrid">
          <button class="urgency-btn selected" data-level="1" onclick="selectUrgency('bowel',1,this)"><span class="u-emoji">üòå</span>No rush</button>
          <button class="urgency-btn" data-level="2" onclick="selectUrgency('bowel',2,this)"><span class="u-emoji">ü§î</span>Mild urgency</button>
          <button class="urgency-btn" data-level="3" onclick="selectUrgency('bowel',3,this)"><span class="u-emoji">üò∞</span>Moderate urgency</button>
          <button class="urgency-btn" data-level="4" onclick="selectUrgency('bowel',4,this)"><span class="u-emoji">üò±</span>Very urgent</button>
        </div>
      </div>

      <!-- DURATION -->
      <div class="form-group">
        <div class="duration-row">
          <label class="form-label" style="margin:0">Duration</label>
          <span class="duration-value" id="bowelDurVal">5 min</span>
        </div>
        <input type="range" class="duration-slider" id="bowelDuration" min="0" max="30" value="5"
          oninput="document.getElementById('bowelDurVal').textContent=this.value<1?'<1 min':this.value+' min'">
        <div class="duration-ticks"><span>&lt;1</span><span>5</span><span>10</span><span>15</span><span>20</span><span>25</span><span>30+</span></div>
      </div>

      <!-- SYMPTOMS -->
      <div class="form-group">
        <label class="form-label">Symptoms</label>
        <div class="symptom-list">
          <label class="symptom-item"><input type="checkbox" id="bSym1" checked><div class="symptom-box">‚úì</div><span class="symptom-label">Felt complete / satisfying</span></label>
          <label class="symptom-item"><input type="checkbox" id="bSym2"><div class="symptom-box">‚úì</div><span class="symptom-label">Had to strain</span></label>
          <label class="symptom-item"><input type="checkbox" id="bSym3"><div class="symptom-box">‚úì</div><span class="symptom-label">Experienced pain</span></label>
          <label class="symptom-item"><input type="checkbox" id="bSym4"><div class="symptom-box">‚úì</div><span class="symptom-label">Noticed blood</span></label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Notes (optional)</label>
        <textarea class="notes-input" id="bowelNotes" rows="2" placeholder="Any additional observations, foods eaten, medications, etc."></textarea>
      </div>
      <button class="btn btn-primary" style="width:100%;margin-top:4px" onclick="submitLog('bowel')">Log Bowel</button>
    </div>
  </div>
</div>

<!-- HTTPS WARNING MODAL -->
<div class="modal-overlay" id="httpsWarningOverlay">
  <div class="modal" style="padding:24px">
    <div class="modal-handle"></div>
    <div style="text-align:center;margin-bottom:16px;font-size:36px">üîí</div>
    <div class="modal-title" style="text-align:center;font-size:20px">HTTPS Required</div>
    <p style="font-size:12px;color:var(--muted);line-height:1.7;text-align:center;margin-bottom:20px;letter-spacing:0.02em">
      Camera access requires a secure <strong>HTTPS</strong> connection. This file is currently running locally, so iOS Safari won't allow camera access.<br><br>
      Host this file on a free service like <strong>Vercel</strong>, <strong>Netlify</strong>, or <strong>GitHub Pages</strong> to enable camera scanning.
    </p>
    <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:20px">
      <div style="font-size:10px;color:var(--muted);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px">Quickest fix</div>
      <div style="font-size:12px;line-height:1.7;letter-spacing:0.02em">
        1. Go to <strong>vercel.com</strong><br>
        2. Drag this HTML file onto the deploy area<br>
        3. Open the <strong>https://‚Ä¶vercel.app</strong> link in Safari
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('httpsWarningOverlay').classList.remove('open')">Got it</button>
      <button class="btn btn-primary" style="flex:1" onclick="document.getElementById('httpsWarningOverlay').classList.remove('open')">OK</button>
    </div>
  </div>
</div>

<!-- CAMERA PERMISSION EXPLAINER MODAL -->
<div class="modal-overlay" id="camPermOverlay">
  <div class="modal" style="padding:24px">
    <div class="modal-handle"></div>
    <div style="text-align:center;margin-bottom:16px;font-size:36px">üì∑</div>
    <div class="modal-title" style="text-align:center;font-size:20px">Camera Access</div>
    <p style="font-size:12px;color:var(--muted);line-height:1.7;text-align:center;margin-bottom:20px;letter-spacing:0.02em">
      FlowLog uses your camera to detect urine color in real time and suggest a hydration level ‚Äî <strong>no photos are saved</strong> and nothing leaves your device.
    </p>
    <div style="background:var(--accent-light);border-radius:10px;padding:12px 14px;margin-bottom:20px;display:flex;gap:10px;align-items:flex-start">
      <span style="font-size:18px;flex-shrink:0">üîê</span>
      <div style="font-size:11px;line-height:1.6;letter-spacing:0.02em;color:var(--accent)">
        The camera feed is processed locally on your device. No images are stored or transmitted.
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('camPermOverlay').classList.remove('open')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="proceedToCamera()">Allow & Continue</button>
    </div>
  </div>
</div>

<!-- CAMERA PERMISSION DENIED MODAL -->
<div class="modal-overlay" id="camDeniedOverlay">
  <div class="modal" style="padding:24px">
    <div class="modal-handle"></div>
    <div style="text-align:center;margin-bottom:16px;font-size:36px">üö´</div>
    <div class="modal-title" style="text-align:center;font-size:20px">Camera Blocked</div>
    <p style="font-size:12px;color:var(--muted);line-height:1.7;text-align:center;margin-bottom:20px;letter-spacing:0.02em">
      Camera permission was denied. To enable it, follow these steps in iOS Settings:
    </p>
    <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:20px">
      <div style="font-size:12px;line-height:2;letter-spacing:0.02em">
        1. Open <strong>Settings</strong> on your iPhone<br>
        2. Scroll down and tap <strong>Safari</strong><br>
        3. Tap <strong>Camera</strong><br>
        4. Select <strong>Allow</strong><br>
        5. Return to this page and try again
      </div>
    </div>
    <div style="background:var(--warn-light);border-radius:10px;padding:12px 14px;margin-bottom:20px;display:flex;gap:10px;align-items:flex-start">
      <span style="font-size:16px;flex-shrink:0">üí°</span>
      <div style="font-size:11px;line-height:1.6;letter-spacing:0.02em;color:var(--warn)">
        Alternatively, you can still select the urine color manually using the color scale below.
      </div>
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="document.getElementById('camDeniedOverlay').classList.remove('open')">OK, I'll Use Manual</button>
  </div>
</div>

<!-- CAMERA OVERLAY -->

<div class="cam-overlay" id="camOverlay">
  <video class="cam-video" id="camVideo" autoplay playsinline muted></video>
  <canvas id="camCanvas" style="display:none"></canvas>

  <div class="cam-header">
    <div class="cam-title">Color Scanner</div>
    <button class="cam-close" onclick="closeCamera()">‚úï</button>
  </div>

  <div class="cam-ui">
    <div class="cam-reticle" id="camReticle">
      <div class="cam-reticle-inner" id="camReticleInner"></div>
    </div>
    <div class="cam-hint">Hold over sample ¬∑ center in circle</div>
  </div>

  <div class="cam-result-bar">
    <div class="cam-result-row">
      <div class="cam-detected-swatch" id="camSwatch"></div>
      <div class="cam-result-info">
        <div class="cam-result-level">Level <span id="camLevel">‚Äì</span></div>
        <div class="cam-result-label" id="camLevelLabel">Scanning‚Ä¶</div>
      </div>
    </div>
    <div class="cam-mini-scale" id="camMiniScale"></div>
    <div class="cam-actions">
      <button class="cam-btn cam-btn-cancel" onclick="closeCamera()">Cancel</button>
      <button class="cam-btn cam-btn-confirm" onclick="confirmCameraColor()">Use This Color</button>
    </div>
  </div>
</div>

<script>
// ====== DATA ======
const STORAGE_KEY = 'flowlog_data';
const WATER_GOAL = 8;

let state = {
  entries: [],
  waterByDay: {},
  currentWeekOffset: 0,
  selectedUrineColor: null,
  selectedBristol: null,
  selectedType: 'urine'
};

function loadData() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const d = JSON.parse(saved);
      state.entries = d.entries || [];
      state.waterByDay = d.waterByDay || {};
    }
  } catch(e) {}
}

function saveData() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      entries: state.entries,
      waterByDay: state.waterByDay
    }));
  } catch(e) {}
}

// ====== BRISTOL DATA ======
const bristolData = [
  { n:1, name:"Separate Hard Lumps", desc:"Like nuts ‚Äî hard to pass", visual:"‚ö´", healthy:false },
  { n:2, name:"Lumpy Sausage", desc:"Sausage-shaped but lumpy", visual:"üü§", healthy:false },
  { n:3, name:"Cracked Sausage", desc:"Sausage with surface cracks", visual:"üü´", healthy:true },
  { n:4, name:"Smooth Sausage", desc:"Smooth, soft ‚Äî ideal!", visual:"üü©", healthy:true },
  { n:5, name:"Soft Blobs", desc:"Soft with clear-cut edges", visual:"üü°", healthy:false },
  { n:6, name:"Fluffy Pieces", desc:"Mushy with ragged edges", visual:"üü†", healthy:false },
  { n:7, name:"Watery", desc:"No solid pieces ‚Äî liquid", visual:"üî¥", healthy:false }
];

const urineData = [
  { level:1, label:"Clear ‚Äî Very well hydrated", bg:"#F5F0C0" },
  { level:2, label:"Pale yellow ‚Äî Well hydrated", bg:"#F0E070" },
  { level:3, label:"Light yellow ‚Äî Good hydration", bg:"#E8C830" },
  { level:4, label:"Yellow ‚Äî Drink more water", bg:"#D4A020" },
  { level:5, label:"Dark yellow ‚Äî Mildly dehydrated", bg:"#B07010" },
  { level:6, label:"Amber ‚Äî Dehydrated", bg:"#8B4800" },
  { level:7, label:"Honey ‚Äî Very dehydrated", bg:"#5C2E00" },
  { level:8, label:"Brown ‚Äî See a doctor", bg:"#3A1800" }
];

// ====== HELPERS ======
function todayKey() {
  return new Date().toISOString().slice(0,10);
}

function formatTime(iso) {
  const d = new Date(iso);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function getWeekDates(offset=0) {
  const today = new Date();
  const dayOfWeek = today.getDay();
  const monday = new Date(today);
  monday.setDate(today.getDate() - dayOfWeek + 1 + offset*7);
  const days = [];
  for(let i=0;i<7;i++){
    const d = new Date(monday);
    d.setDate(monday.getDate()+i);
    days.push(d);
  }
  return days;
}

function dateKey(d) {
  return d.toISOString().slice(0,10);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2000);
}

// ====== INIT ======
function init() {
  loadData();
  setHeaderDate();
  buildGlasses();
  buildUrineScale();
  buildBristolSelect();
  buildBristolRef();
  renderToday();
  renderWeek();
  renderInsights();
  updateStreak();
}

function setHeaderDate() {
  const opts = { weekday:'long', month:'long', day:'numeric' };
  document.getElementById('dateLabel').textContent = new Date().toLocaleDateString('en-US', opts);
}

function updateStreak() {
  // Count consecutive days with entries
  let streak = 0;
  const today = new Date();
  for(let i=0;i<365;i++){
    const d = new Date(today);
    d.setDate(today.getDate()-i);
    const key = dateKey(d);
    const hasEntries = state.entries.some(e=>e.date===key);
    const hasWater = state.waterByDay[key] > 0;
    if(hasEntries || hasWater) streak++;
    else break;
  }
  document.getElementById('streakBadge').textContent = `üî• ${Math.max(1,streak)}-day streak`;
}

// ====== HYDRATION ======
function buildGlasses() {
  const row = document.getElementById('glassesRow');
  row.innerHTML = '';
  const count = state.waterByDay[todayKey()] || 0;
  for(let i=0;i<WATER_GOAL;i++){
    const g = document.createElement('div');
    g.className = 'glass' + (i < count ? ' filled' : '');
    g.onclick = () => { state.waterByDay[todayKey()] = i+1 > count ? i+1 : i; saveData(); buildGlasses(); updateHydrationDisplay(); };
    row.appendChild(g);
  }
  updateHydrationDisplay();
}

function updateHydrationDisplay() {
  const count = state.waterByDay[todayKey()] || 0;
  document.getElementById('hydrationCount').textContent = count;
  const pct = Math.min(100, (count/WATER_GOAL)*100);
  document.getElementById('hydrationProgress').style.width = pct+'%';
  const msgs = ['Start hydrating!','Keep going!','Good progress!','Halfway there!','Almost there!','Great job!','Nearly full!','Goal reached! üéâ','Above and beyond!'];
  const idx = Math.min(count, msgs.length-1);
  document.getElementById('waterGoalText').textContent = `${count} / ${WATER_GOAL} glasses ‚Äî ${msgs[idx]}`;
}

function addWater(delta) {
  const key = todayKey();
  state.waterByDay[key] = Math.max(0, Math.min(12, (state.waterByDay[key]||0)+delta));
  saveData();
  buildGlasses();
  renderWeek();
  renderInsights();
  showToast(delta>0 ? 'üíß Glass added!' : 'üíß Glass removed');
}

// ====== MODAL ======
function openModal() {
  document.getElementById('modalOverlay').classList.add('open');
  state.selectedUrineColor = null;
  state.selectedBristol = null;
  document.getElementById('urineNotes').value = '';
  document.getElementById('bowelNotes').value = '';
  document.querySelectorAll('.urine-swatch').forEach(s=>s.classList.remove('selected'));
  document.querySelectorAll('#bristolSelect .bristol-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('urineColorLabel').textContent = 'Select a color above or scan';
  document.getElementById('urinePreview').style.background = 'transparent';
  // Reset urgency
  urineUrgency = 1; bowelUrgency = 1;
  document.querySelectorAll('#urineUrgencyGrid .urgency-btn').forEach((b,i)=>b.classList.toggle('selected',i===0));
  document.querySelectorAll('#bowelUrgencyGrid .urgency-btn').forEach((b,i)=>b.classList.toggle('selected',i===0));
  // Reset duration
  document.getElementById('urineDuration').value = 1;
  document.getElementById('urineDurVal').textContent = '1 min';
  document.getElementById('bowelDuration').value = 5;
  document.getElementById('bowelDurVal').textContent = '5 min';
  // Reset symptoms
  ['uSym1','uSym2','uSym3','uSym4'].forEach(id=>document.getElementById(id).checked=false);
  document.getElementById('bSym1').checked = true;
  ['bSym2','bSym3','bSym4'].forEach(id=>document.getElementById(id).checked=false);
  selectType('urine');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function closeModalOutside(e) {
  if(e.target.id === 'modalOverlay') closeModal();
}

function selectType(type) {
  state.selectedType = type;
  ['urine','bowel'].forEach(t=>{
    document.getElementById('type'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('active', t===type);
    document.getElementById('form'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('active', t===type);
  });
}

// ====== URINE SCALE ======
function buildUrineScale() {
  const scale = document.getElementById('urineScale');
  scale.innerHTML = '';
  urineData.forEach((u,i)=>{
    const s = document.createElement('div');
    s.className = 'urine-swatch';
    s.style.background = u.bg;
    s.title = u.label;
    s.onclick = () => {
      document.querySelectorAll('.urine-swatch').forEach(x=>x.classList.remove('selected'));
      s.classList.add('selected');
      state.selectedUrineColor = u.level;
      document.getElementById('urineColorLabel').textContent = u.label;
      document.getElementById('urinePreview').style.background = u.bg;
    };
    scale.appendChild(s);
  });
}

// ====== BRISTOL ======
function buildBristolSelect() {
  const grid = document.getElementById('bristolSelect');
  grid.innerHTML = '';
  bristolData.forEach(b=>{
    const btn = document.createElement('button');
    btn.className = 'bristol-btn';
    btn.innerHTML = `
      <div class="bristol-num">${b.n}</div>
      <div class="bristol-info">
        <div class="bristol-name">${b.name}</div>
        <div class="bristol-desc">${b.desc}</div>
      </div>
      <div class="bristol-visual">${b.visual}</div>
    `;
    btn.onclick = () => {
      document.querySelectorAll('#bristolSelect .bristol-btn').forEach(x=>x.classList.remove('selected'));
      btn.classList.add('selected');
      state.selectedBristol = b.n;
    };
    grid.appendChild(btn);
  });
}

function buildBristolRef() {
  const ref = document.getElementById('bristolRef');
  ref.innerHTML = '';
  bristolData.forEach(b=>{
    const row = document.createElement('div');
    row.className = 'bristol-btn';
    row.style.cursor = 'default';
    row.style.background = b.healthy ? 'var(--accent-light)' : '';
    row.innerHTML = `
      <div class="bristol-num">${b.n}</div>
      <div class="bristol-info">
        <div class="bristol-name">${b.name} ${b.healthy ? '‚úì' : ''}</div>
        <div class="bristol-desc">${b.desc}</div>
      </div>
      <div class="bristol-visual">${b.visual}</div>
    `;
    ref.appendChild(row);
  });
}

// ====== SUBMIT ======
function submitLog(type) {
  const entry = {
    id: Date.now(),
    type,
    date: todayKey(),
    time: new Date().toISOString()
  };

  if(type === 'urine') {
    if(!state.selectedUrineColor) { showToast('‚ö†Ô∏è Select a urine color'); return; }
    entry.color = state.selectedUrineColor;
    entry.colorLabel = urineData[state.selectedUrineColor-1].label;
    entry.colorBg = urineData[state.selectedUrineColor-1].bg;
    entry.urgency = urineUrgency;
    entry.duration = parseInt(document.getElementById('urineDuration').value);
    entry.symptoms = [
      document.getElementById('uSym1').checked ? 'Felt complete' : null,
      document.getElementById('uSym2').checked ? 'Burning/discomfort' : null,
      document.getElementById('uSym3').checked ? 'Cloudy appearance' : null,
      document.getElementById('uSym4').checked ? 'Blood noticed' : null,
    ].filter(Boolean);
    entry.notes = document.getElementById('urineNotes').value;
  } else {
    if(!state.selectedBristol) { showToast('‚ö†Ô∏è Select a Bristol type'); return; }
    entry.bristol = state.selectedBristol;
    const bd = bristolData[state.selectedBristol-1];
    entry.bristolName = bd.name;
    entry.bristolVisual = bd.visual;
    entry.healthy = bd.healthy;
    entry.urgency = bowelUrgency;
    entry.duration = parseInt(document.getElementById('bowelDuration').value);
    entry.symptoms = [
      document.getElementById('bSym1').checked ? 'Felt complete' : null,
      document.getElementById('bSym2').checked ? 'Had to strain' : null,
      document.getElementById('bSym3').checked ? 'Experienced pain' : null,
      document.getElementById('bSym4').checked ? 'Blood noticed' : null,
    ].filter(Boolean);
    entry.notes = document.getElementById('bowelNotes').value;
  }

  state.entries.unshift(entry);
  saveData();
  closeModal();
  renderToday();
  renderWeek();
  renderInsights();
  updateStreak();
  showToast(type === 'urine' ? 'üöø Urine logged!' : '‚úÖ Bowel movement logged!');
}

// ====== RENDER TODAY ======
function renderToday() {
  const list = document.getElementById('entryList');
  const todayEntries = state.entries.filter(e=>e.date===todayKey());

  if(!todayEntries.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No entries yet today.<br>Tap + to log a movement.</div></div>`;
    return;
  }

  list.innerHTML = '';
  todayEntries.forEach(e=>{
    const div = document.createElement('div');
    div.className = 'entry';
    const urgStr = e.urgency && e.urgency > 1 ? ` ¬∑ ${urgencyEmojis[e.urgency]} ${urgencyLabels[e.urgency]}` : '';
    const durStr = e.duration ? ` ¬∑ ${e.duration}min` : '';
    const symStr = e.symptoms && e.symptoms.length ? ` ¬∑ ${e.symptoms.join(', ')}` : '';
    if(e.type==='urine') {
      div.innerHTML = `
        <div class="entry-type urine" style="background:${e.colorBg}20">üöø</div>
        <div class="entry-info">
          <div class="entry-title">Urine ‚Äî Level ${e.color}${urgStr}</div>
          <div class="entry-detail">${e.colorLabel}${durStr}${symStr}${e.notes?' ¬∑ '+e.notes:''}</div>
        </div>
        <div class="entry-time">${formatTime(e.time)}</div>
        <button class="entry-delete" onclick="deleteEntry(${e.id})">√ó</button>
      `;
    } else {
      div.innerHTML = `
        <div class="entry-type bowel">${e.bristolVisual}</div>
        <div class="entry-info">
          <div class="entry-title">Bowel ‚Äî Type ${e.bristol}${urgStr}</div>
          <div class="entry-detail">${e.bristolName}${durStr}${symStr}${e.notes?' ¬∑ '+e.notes:''}</div>
        </div>
        <div class="entry-time">${formatTime(e.time)}</div>
        <button class="entry-delete" onclick="deleteEntry(${e.id})">√ó</button>
      `;
    }
    list.appendChild(div);
  });
}

function deleteEntry(id) {
  state.entries = state.entries.filter(e=>e.id!==id);
  saveData();
  renderToday();
  renderWeek();
  renderInsights();
  showToast('Entry deleted');
}

// ====== RENDER WEEK ======
let weekOffset = 0;

function changeWeek(delta) {
  weekOffset += delta;
  if(weekOffset > 0) weekOffset = 0;
  renderWeek();
}

function renderWeek() {
  const days = getWeekDates(weekOffset);
  const today = todayKey();

  // Week label
  const fmt = { month:'short', day:'numeric' };
  document.getElementById('weekLabel').textContent =
    days[0].toLocaleDateString('en-US',fmt) + ' ‚Äì ' + days[6].toLocaleDateString('en-US',fmt);

  // Mini cal
  const cal = document.getElementById('miniCal');
  cal.innerHTML = '';
  ['M','T','W','T','F','S','S'].forEach(d=>{
    const h = document.createElement('div');
    h.className = 'cal-day-head';
    h.textContent = d;
    cal.appendChild(h);
  });

  days.forEach(d=>{
    const key = dateKey(d);
    const hasUrine = state.entries.some(e=>e.date===key&&e.type==='urine');
    const hasBowel = state.entries.some(e=>e.date===key&&e.type==='bowel');
    const hasWater = (state.waterByDay[key]||0) > 0;

    const cell = document.createElement('div');
    cell.className = 'cal-day' + (key===today?' today':'');
    const dots = document.createElement('div');
    dots.className = 'cal-dot-row';
    if(hasWater) dots.innerHTML += `<div class="cal-dot" style="background:var(--blue)"></div>`;
    if(hasUrine) dots.innerHTML += `<div class="cal-dot" style="background:var(--warn)"></div>`;
    if(hasBowel) dots.innerHTML += `<div class="cal-dot" style="background:var(--accent)"></div>`;
    cell.innerHTML = `<span>${d.getDate()}</span>`;
    cell.appendChild(dots);
    cal.appendChild(cell);
  });

  // Bar chart
  const chart = document.getElementById('weekChart');
  chart.innerHTML = '';
  const maxW = Math.max(8, ...days.map(d=>state.waterByDay[dateKey(d)]||0));
  const maxU = Math.max(4, ...days.map(d=>state.entries.filter(e=>e.date===dateKey(d)&&e.type==='urine').length));
  const maxB = Math.max(4, ...days.map(d=>state.entries.filter(e=>e.date===dateKey(d)&&e.type==='bowel').length));

  days.forEach(d=>{
    const key = dateKey(d);
    const w = state.waterByDay[key]||0;
    const u = state.entries.filter(e=>e.date===key&&e.type==='urine').length;
    const b = state.entries.filter(e=>e.date===key&&e.type==='bowel').length;
    const group = document.createElement('div');
    group.className = 'bar-group';
    const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    group.innerHTML = `
      <div class="bar water-bar" style="height:${(w/maxW)*60}px"></div>
      <div class="bar urine-bar" style="height:${(u/maxU)*60}px"></div>
      <div class="bar bowel-bar" style="height:${(b/maxB)*60}px"></div>
      <div class="bar-label">${dayNames[d.getDay()===0?6:d.getDay()-1]}</div>
    `;
    chart.appendChild(group);
  });

  // Stats
  const waterVals = days.map(d=>state.waterByDay[dateKey(d)]||0);
  const avgW = (waterVals.reduce((a,b)=>a+b,0)/7).toFixed(1);
  const totalU = days.reduce((acc,d)=>acc+state.entries.filter(e=>e.date===dateKey(d)&&e.type==='urine').length,0);
  const totalB = days.reduce((acc,d)=>acc+state.entries.filter(e=>e.date===dateKey(d)&&e.type==='bowel').length,0);
  document.getElementById('avgWater').textContent = avgW;
  document.getElementById('totalUrine').textContent = totalU;
  document.getElementById('totalBowel').textContent = totalB;
}

// ====== INSIGHTS ======
function renderInsights() {
  const list = document.getElementById('insightsList');
  list.innerHTML = '';
  const insights = [];

  const todayW = state.waterByDay[todayKey()] || 0;
  if(todayW >= WATER_GOAL) {
    insights.push({type:'good', icon:'üíß', title:'Hydration goal reached!', text:`You've had ${todayW} glasses today ‚Äî excellent hydration.`});
  } else if(todayW >= 4) {
    insights.push({type:'info', icon:'üíß', title:'Halfway to hydration goal', text:`${todayW} of ${WATER_GOAL} glasses today. Try to drink ${WATER_GOAL-todayW} more.`});
  } else {
    insights.push({type:'warn', icon:'‚ö†Ô∏è', title:'Low hydration today', text:`Only ${todayW} glasses so far. Aim for at least ${WATER_GOAL} glasses daily.`});
  }

  const recentBowel = state.entries.filter(e=>e.type==='bowel').slice(0,5);
  if(recentBowel.length > 0) {
    const types = recentBowel.map(e=>e.bristol);
    const healthy = types.filter(t=>t===3||t===4).length;
    if(healthy === types.length) {
      insights.push({type:'good', icon:'‚úÖ', title:'Healthy bowel pattern', text:'Your recent bowel movements are Types 3-4 ‚Äî the ideal range on the Bristol Scale.'});
    } else if(types.some(t=>t<=2)) {
      insights.push({type:'warn', icon:'üåæ', title:'Signs of constipation', text:'Recent Type 1-2 stools suggest you may be constipated. Increase fiber and water intake.'});
    } else if(types.some(t=>t>=6)) {
      insights.push({type:'warn', icon:'‚ö°', title:'Loose stools detected', text:'Type 6-7 stools may indicate diarrhea. Stay hydrated and consider dietary adjustments.'});
    }
  } else {
    insights.push({type:'info', icon:'üìã', title:'No bowel data yet', text:'Start logging bowel movements to get personalized health insights.'});
  }

  const recentUrine = state.entries.filter(e=>e.type==='urine').slice(0,5);
  if(recentUrine.length > 0) {
    const avgColor = recentUrine.reduce((a,b)=>a+b.color,0)/recentUrine.length;
    if(avgColor <= 3) {
      insights.push({type:'good', icon:'üü°', title:'Well hydrated based on urine', text:'Your recent urine color suggests good hydration levels.'});
    } else if(avgColor >= 5) {
      insights.push({type:'warn', icon:'üü†', title:'Dark urine ‚Äî drink water', text:'Your urine color suggests dehydration. Increase water intake throughout the day.'});
    }
  }

  insights.push({type:'info', icon:'ü©∫', title:'Disclaimer', text:'FlowLog is a personal tracking tool. Consult a healthcare provider for medical concerns.'});

  insights.forEach(insight=>{
    const div = document.createElement('div');
    div.className = `insight ${insight.type}`;
    div.innerHTML = `
      <div class="insight-icon">${insight.icon}</div>
      <div class="insight-text"><strong>${insight.title}</strong><br>${insight.text}</div>
    `;
    list.appendChild(div);
  });
}

// ====== TABS ======
function switchTab(tab) {
  ['log','history','insights'].forEach(t=>{
    document.getElementById('section-'+t).classList.toggle('active', t===tab);
    document.getElementById('nav-'+t)?.classList.toggle('active', t===tab);
  });
  document.querySelectorAll('.nav-btn').forEach((btn,i)=>{
    btn.classList.toggle('active', ['log','history','insights'][i]===tab);
  });
  if(tab==='history') renderWeek();
  if(tab==='insights') renderInsights();
}

// ====== SEED DEMO DATA (first run) ======
function seedDemoIfEmpty() {
  if(state.entries.length > 0) return;
  const today = new Date();
  for(let i=6;i>=0;i--){
    const d = new Date(today);
    d.setDate(today.getDate()-i);
    const key = dateKey(d);
    state.waterByDay[key] = Math.floor(Math.random()*4)+4;
    const urineCount = Math.floor(Math.random()*3)+2;
    for(let u=0;u<urineCount;u++){
      const t = new Date(d);
      t.setHours(7+u*3, Math.floor(Math.random()*60));
      const color = Math.floor(Math.random()*4)+1;
      state.entries.push({
        id: t.getTime()+u,
        type:'urine',
        date:key,
        time:t.toISOString(),
        color,
        colorLabel:urineData[color-1].label,
        colorBg:urineData[color-1].bg,
        notes:''
      });
    }
    if(i%2===0) {
      const t = new Date(d);
      t.setHours(8, 30);
      const bristol = Math.random()>0.3 ? 3+Math.round(Math.random()) : Math.floor(Math.random()*7)+1;
      const bd = bristolData[bristol-1];
      state.entries.push({
        id: t.getTime(),
        type:'bowel',
        date:key,
        time:t.toISOString(),
        bristol,
        bristolName:bd.name,
        bristolVisual:bd.visual,
        healthy:bd.healthy,
        notes:''
      });
    }
  }
  saveData();
}

// ====== URGENCY ======
let urineUrgency = 1;
let bowelUrgency = 1;

function selectUrgency(type, level, btn) {
  const gridId = type === 'urine' ? 'urineUrgencyGrid' : 'bowelUrgencyGrid';
  document.querySelectorAll(`#${gridId} .urgency-btn`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  if (type === 'urine') urineUrgency = level;
  else bowelUrgency = level;
}

const urgencyLabels = ['', 'No rush', 'Mild urgency', 'Moderate urgency', 'Very urgent'];
const urgencyEmojis = ['', 'üòå', 'ü§î', 'üò∞', 'üò±'];
loadData();
seedDemoIfEmpty();
init();

// ====== CAMERA COLOR SCANNER ======
let camStream = null;
let camAnimFrame = null;
let camDetectedLevel = null;
let camPermissionGranted = false;

// On load: check HTTPS and camera API support, update button accordingly
(function checkCamSupport() {
  const wrapper = document.getElementById('camScanWrapper');
  if (!wrapper) return;

  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  const hasAPI = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);

  if (!isSecure) {
    // Show a subtle warning badge under the button
    const badge = document.createElement('div');
    badge.style.cssText = 'font-size:10px;color:var(--warn);letter-spacing:0.04em;text-align:center;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:4px';
    badge.innerHTML = '‚ö†Ô∏è HTTPS required for camera ‚Äî tap to learn more';
    badge.style.cursor = 'pointer';
    badge.onclick = () => document.getElementById('httpsWarningOverlay').classList.add('open');
    wrapper.appendChild(badge);
    // Change scan button to open the explainer instead
    document.getElementById('camScanBtn').onclick = () => document.getElementById('httpsWarningOverlay').classList.add('open');
  } else if (!hasAPI) {
    const badge = document.createElement('div');
    badge.className = 'cam-no-support';
    badge.textContent = 'üì∑ Camera not supported in this browser';
    wrapper.appendChild(badge);
    document.getElementById('camScanBtn').disabled = true;
    document.getElementById('camScanBtn').style.opacity = '0.4';
  }
})();

function handleCameraTap() {
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if (!isSecure) {
    document.getElementById('httpsWarningOverlay').classList.add('open');
    return;
  }
  // If already granted before in this session, skip explainer
  if (camPermissionGranted) {
    openCamera();
    return;
  }
  // Show friendly explainer first
  document.getElementById('camPermOverlay').classList.add('open');
}

function proceedToCamera() {
  document.getElementById('camPermOverlay').classList.remove('open');
  openCamera();
}

// Build mini scale in camera overlay
function buildCamMiniScale() {
  const row = document.getElementById('camMiniScale');
  row.innerHTML = '';
  urineData.forEach(u => {
    const d = document.createElement('div');
    d.className = 'cam-mini-swatch';
    d.id = `camMini${u.level}`;
    d.style.background = u.bg;
    row.appendChild(d);
  });
}

async function openCamera() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showToast('‚ö†Ô∏è Camera not available in this browser');
    return;
  }
  try {
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    camPermissionGranted = true;
    const video = document.getElementById('camVideo');
    video.srcObject = camStream;
    await video.play();
    buildCamMiniScale();
    document.getElementById('camOverlay').classList.add('open');
    startColorSampling();
  } catch(err) {
    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
      camPermissionGranted = false;
      document.getElementById('camDeniedOverlay').classList.add('open');
    } else if (err.name === 'NotFoundError') {
      showToast('‚ö†Ô∏è No camera found on this device');
    } else {
      showToast('‚ö†Ô∏è Could not access camera: ' + err.message);
    }
  }
}

function closeCamera() {
  if (camStream) {
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
  if (camAnimFrame) {
    cancelAnimationFrame(camAnimFrame);
    camAnimFrame = null;
  }
  document.getElementById('camOverlay').classList.remove('open');
}

function startColorSampling() {
  const video = document.getElementById('camVideo');
  const canvas = document.getElementById('camCanvas');
  const ctx = canvas.getContext('2d');

  function sample() {
    if (!camStream) return;
    if (video.readyState < 2) { camAnimFrame = requestAnimationFrame(sample); return; }

    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Sample center region (20x20 pixels)
    const cx = Math.floor(canvas.width / 2);
    const cy = Math.floor(canvas.height / 2);
    const size = 20;
    const imgData = ctx.getImageData(cx - size/2, cy - size/2, size, size);
    const d = imgData.data;

    let r=0, g=0, b=0, count=0;
    for (let i=0; i<d.length; i+=4) {
      r += d[i]; g += d[i+1]; b += d[i+2]; count++;
    }
    r = Math.round(r/count);
    g = Math.round(g/count);
    b = Math.round(b/count);

    const detectedLevel = matchUrineColor(r, g, b);
    camDetectedLevel = detectedLevel;
    updateCamUI(r, g, b, detectedLevel);

    camAnimFrame = requestAnimationFrame(sample);
  }

  camAnimFrame = requestAnimationFrame(sample);
}

// Match RGB to closest urine level using weighted color distance
function matchUrineColor(r, g, b) {
  const refs = [
    [245, 240, 192],
    [240, 224, 112],
    [232, 200,  48],
    [212, 160,  32],
    [176, 112,  16],
    [139,  72,   0],
    [ 92,  46,   0],
    [ 58,  24,   0],
  ];

  let bestLevel = 1;
  let bestDist = Infinity;

  refs.forEach(([rr, gg, bb], i) => {
    const dr = r - rr, dg = g - gg, db = b - bb;
    const dist = Math.sqrt(dr*dr*0.3 + dg*dg*0.59 + db*db*0.11);
    if (dist < bestDist) { bestDist = dist; bestLevel = i + 1; }
  });

  return bestLevel;
}

function updateCamUI(r, g, b, level) {
  const detectedColor = `rgb(${r},${g},${b})`;
  const matchedUrine = urineData[level - 1];

  document.getElementById('camReticleInner').style.background = detectedColor;
  document.getElementById('camSwatch').style.background = matchedUrine.bg;
  document.getElementById('camLevel').textContent = level;
  document.getElementById('camLevelLabel').textContent = matchedUrine.label;

  urineData.forEach(u => {
    const el = document.getElementById(`camMini${u.level}`);
    if (el) el.classList.toggle('active', u.level === level);
  });

  const reticle = document.getElementById('camReticle');
  if (level <= 3) reticle.style.borderColor = 'rgba(120,220,160,0.95)';
  else if (level <= 5) reticle.style.borderColor = 'rgba(255,200,80,0.95)';
  else reticle.style.borderColor = 'rgba(220,100,80,0.95)';
}

function confirmCameraColor() {
  if (!camDetectedLevel) { showToast('‚ö†Ô∏è No color detected yet'); return; }
  closeCamera();

  const level = camDetectedLevel;
  state.selectedUrineColor = level;

  document.querySelectorAll('.urine-swatch').forEach((s, i) => {
    s.classList.toggle('selected', i === level - 1);
  });

  const ud = urineData[level - 1];
  document.getElementById('urineColorLabel').textContent = ud.label;
  document.getElementById('urinePreview').style.background = ud.bg;
  showToast(`üì∑ Level ${level} detected & applied`);
}
</script>
</body>
</html>
